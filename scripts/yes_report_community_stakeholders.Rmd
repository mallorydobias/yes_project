---
title: "Project YES: Meaningful and Scalable Impact on Youth Mental Health"
author: "Mallory Dobias, PhD"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: no
      smooth_scroll: no
  pdf_document:
    toc: yes
    toc_depth: '5'
  word_document:
    toc: yes
    toc_depth: '5'
geometry: margin=0.50in
---

```{r setup, include=FALSE}

## Setting up R

knitr::opts_chunk$set(echo = TRUE)

if(!require(pointblank)){install.packages('pointblank')}
library(pointblank) # installing and calling pointblank package early in Markdown

validate_rmd(summary = TRUE, log_to_file = FALSE) # allowing validation from pointblank package within Markdown

```

```{r packages, include=FALSE}

## Loading packages

if(!require(here)){install.packages('here')}
library(here)

if(!require(dplyr)){install.packages('dplyr')}
library(dplyr)

if(!require(stringr)){install.packages('stringr')}
library(stringr)

if(!require(tidyr)){install.packages('tidyr')}
library(tidyr)

if(!require(readr)){install.packages('readr')}
library(readr)

if(!require(tidyverse)){install.packages('tidyverse')}
library(tidyverse)

if(!require(showtext)){install.packages('showtext')}
library(showtext)

if(!require(patchwork)){install.packages('patchwork')}
library(patchwork)

if(!require(stats)){install.packages('stats')}
library(stats)

if(!require(MOTE)){install.packages('MOTE')}
library(MOTE)

if(!require(rempsyc)){install.packages('rempsyc')}
library(rempsyc)

if(!require(rmarkdown)){install.packages('rmarkdown')}
library(rmarkdown)

if(!require(officer)){install.packages('officer')}
library(officer)

if(!require(flextable)){install.packages('flextable')}
library(flextable)

if(!require(ggridges)){install.packages('ggridges')}
library(ggridges)

if(!require(ggplot2)){install.packages('ggplot2')}
library(ggplot2)

if(!require(broom)){install.packages('broom')}
library(broom)

if(!require(tidytext)){install.packages('tidytext')}
library(tidytext)

```

```{r note, include=FALSE}

## The next several chunks setup the data for our analysis and 
## calculate values that are required for the summary

```

```{r reading in data, include=FALSE}

## Reading in cleaned survey data

library(here) # places working directory at root of project folder

data <- readRDS(here("data", "clean", "yes_data_english_clean.Rds")) # directing to data from project folder root

# head(data) # looks good

```

```{r filtering to youth only data for analysis, include=FALSE}

## Filtering to youth only for our analysis

data_youth <- data %>%
  filter(dem_age != "18 or older" &
         dem_age != "17 or older" &
         dem_age != "16-20" &
         dem_age != "21-25" &   
         dem_age != "26-30" & 
         dem_age != "31-35" &  
         dem_age != "36-40" & 
         dem_age != "41-45" & 
         dem_age != "46-50" & 
         dem_age != "51-55" & 
         dem_age != "56-60" & 
         dem_age != "61-65" & 
         dem_age != "66-70" & 
         dem_age != "71-75" & 
         dem_age != "76-80" &
         dem_age != "81-85" &
         dem_age != "86-90" &
         dem_age != "91-95" &
         dem_age != "96-100" &
         dem_age != "101 or older")

## Checking that all dfs have values in this column (d03 not present because no age item)

data_youth %>%
  select(data_id, dem_age) %>%
  filter(!is.na(dem_age)) %>%
  group_by(data_id) %>%
  tally()

## Checking that data come from youth

data_youth %>%
  select(data_id, dem_age) %>%
  group_by(dem_age) %>%
  tally()

```

```{r calculating n milestones, include=FALSE}

## Calculating n milestones

n_started_survey <- data_youth %>%
  tally() # started the survey

n_chose_any_ssi <- data_youth %>%
  filter(!is.na(ssi_choice)) %>%
  tally() # chose any ssi

n_chose_abc <- data_youth %>%
  filter(str_detect(ssi_choice, "ABC")) %>%
  tally() # chose abc

n_chose_care <- data_youth %>%
  filter(str_detect(ssi_choice, "CARE")) %>%
  tally() # chose care
  
n_chose_pp <- data_youth %>%
  filter(str_detect(ssi_choice, "Personality")) %>%
  tally() # chose pp

n_chose_rise <- data_youth %>%
  filter(str_detect(ssi_choice, "RISE")) %>%
  tally() # chose pp

## Checking that all dfs have values in the ssi_choice column (d03 not present because no age item)

data_youth %>%
  select(data_id, ssi_choice) %>%
  filter(!is.na(ssi_choice)) %>%
  group_by(data_id) %>%
  tally()

```

```{r calculating perc milestones, include=FALSE}

## Percent of cases who chose an ssi, of those who started the survey

perc_chose_any_ssi <- round((n_chose_any_ssi/n_started_survey)*100, 2)

## Percent of cases who chose abc, of those who chose any ssi

perc_chose_abc <- round((n_chose_abc/n_chose_any_ssi)*100, 2)

## Percent of cases who chose care, of those who chose any ssi

perc_chose_care <- round((n_chose_care/n_chose_any_ssi)*100, 2)

## Percent of cases who chose pp, of those who chose any ssi

perc_chose_pp <- round((n_chose_pp/n_chose_any_ssi)*100, 2)

## Percent of cases who chose pp, of those who chose any ssi

perc_chose_rise <- round((n_chose_rise/n_chose_any_ssi)*100, 2)

```

```{r calculating perc complete of those who started for abc, include=FALSE}

n_started_abc <- data_youth %>%
  filter(str_detect(ssi_choice, "ABC")) %>% # filtering to those who chose this ssi
  filter(!is.na(ssi_started)) %>% # filtering to those who started an ssi
  select(ssi_choice, ssi_started) %>%
  tally()

n_completed_abc <- data_youth %>%
  filter(str_detect(ssi_choice, "ABC")) %>% # filtering to those who chose this ssi
  filter(!is.na(ssi_completed)) %>% # filtering to those who started an ssi
  select(ssi_choice, ssi_completed) %>%
  tally()

perc_completed_abc <- round((n_completed_abc / n_started_abc) * 100, 2)

## Checking that all dfs have values in these columns (d03 not present because no age item)

data_youth %>%
  select(data_id, ssi_started) %>%
  filter(!is.na(ssi_started)) %>%
  group_by(data_id) %>%
  tally()

data_youth %>%
  select(data_id, ssi_completed) %>%
  filter(!is.na(ssi_completed)) %>%
  group_by(data_id) %>%
  tally()

# data %>%
#   filter(data_id == "d05") %>%
#   select(data_id, ssi_completed, dem_age) # d05 has no ssi_started responses from youth

```

```{r writing custom function for perc completed ssi, include=FALSE}

# Define the custom function
filter_and_summarize_ssi <- function(data, filter_string, started_var_name, completed_var_name) {
  # Filter for those who started the SSI and assign globally
  assign(started_var_name, data %>%
           filter(str_detect(ssi_choice, filter_string)) %>%
           filter(!is.na(ssi_started)) %>%
           tally(), envir = .GlobalEnv)
  
  # Filter for those who completed the SSI and save variables to global environment
  assign(completed_var_name, data %>%
           filter(str_detect(ssi_choice, filter_string)) %>%
           filter(!is.na(ssi_completed)) %>%
           tally(), envir = .GlobalEnv)
  
  # Calculate percentage completed and save variables to global environment
  perc_completed_name <- paste0("perc_completed_", tolower(gsub("\\.", "", filter_string)))
  assign(perc_completed_name, round((get(completed_var_name, envir = .GlobalEnv) / get(started_var_name, envir = .GlobalEnv)) * 100, 2), envir = .GlobalEnv)
  
  # Return the results as a list
  list(
    started = get(started_var_name, envir = .GlobalEnv),
    completed = get(completed_var_name, envir = .GlobalEnv),
    perc_completed = get(perc_completed_name, envir = .GlobalEnv)
  )
}

```

```{r using custom function for perc completed abc, include=FALSE}

# Testing custom function for perc completion on abc
results <- filter_and_summarize_ssi(data_youth, "ABC", "n_started_abc", "n_completed_abc")
print(results)

# Later, you can access n_started_abc, n_completed_abc, and perc_completed_abc from the global environment:
print(n_started_abc)
print(n_completed_abc)
print(perc_completed_abc)

```

```{r using custom function for perc completed care, include=FALSE}

# Testing custom function for perc completion on care
results <- filter_and_summarize_ssi(data_youth, "CARE", "n_started_care", "n_completed_care")
print(results)

# Later, you can access these vars from the global environment:
print(n_started_care)
print(n_completed_care)
print(perc_completed_care)

```

```{r using custom function for perc completed pp, include=FALSE}

# Testing custom function for perc completion on pp
results <- filter_and_summarize_ssi(data_youth, "Personality", "n_started_pp", "n_completed_pp")
print(results)

# Later, you can access these vars from the global environment:
print(n_started_pp)
print(n_completed_pp)
print(perc_completed_personality)

```

```{r using custom function for perc completed rise, include=FALSE}

# Testing custom function for perc completion on rise
results <- filter_and_summarize_ssi(data_youth, "RISE", "n_started_rise", "n_completed_rise")
print(results)

# Later, you can access these vars from the global environment:
print(n_started_rise)
print(n_completed_rise)
print(perc_completed_rise)

```

```{r calculating perc complete of those who started any ssi, include=FALSE}

n_started_any_ssi <- data_youth %>%
  filter(!is.na(ssi_started)) %>% # filtering to those who started an ssi
  select(ssi_choice, ssi_started) %>%
  tally()

n_completed_any_ssi <- data_youth %>%
  filter(!is.na(ssi_completed)) %>% # filtering to those who started an ssi
  select(ssi_choice, ssi_completed) %>%
  tally()

perc_completed_any_ssi <- round((n_completed_any_ssi / n_started_any_ssi) * 100, 2)

```

```{r calculating perc agreed to questionnaires, include=FALSE}

n_agreed_questionnaires <- data_youth %>%
  filter(volunteer_questionnaires_yn == "Yes") %>% # filtering to those who agreed
  select(volunteer_questionnaires_yn) %>%
  tally()

n_answered_questionnaires_item <- data_youth %>%
  filter(!is.na(volunteer_questionnaires_yn)) %>% # filtering to those who answered the question
  select(volunteer_questionnaires_yn) %>%
  tally()

perc_agreed_questionnaires <- round((n_agreed_questionnaires / n_answered_questionnaires_item) * 100, 2) # percent agreed, of those who were asked

## Checking that all dfs have values in this columns (d03 not present because no age item, d02 does not have volunteer item)

data_youth %>%
  select(data_id, volunteer_questionnaires_yn) %>%
  filter(!is.na(volunteer_questionnaires_yn)) %>%
  group_by(data_id) %>%
  tally()

```

```{r calculating aggregated pfs mean overall, include=FALSE}

## Calculating overall pfs mean, across all ssis

m_pfs_overall <- round(mean(data_youth$pfs_mean, na.rm = TRUE), 2)

## Checking that all dfs have values in this column (d03 no age var, d16 has no completers yet, d05 has no youth post-responses)

data_youth %>%
  select(data_id, pfs_mean) %>%
  filter(!is.na(pfs_mean)) %>%
  group_by(data_id) %>%
  tally()

```

```{r calculating aggregated pfs mean for abc, include=FALSE}

## Pulling only abc responses

data_youth_abc <- data_youth %>%
  filter(str_detect(ssi_choice, "ABC")) # filtering to those who chose abc

## Calculating overall pfs mean for abc

m_pfs_abc <- round(mean(data_youth_abc$pfs_mean, na.rm = TRUE), 2)

```

```{r calculating aggregated pfs mean for care, include=FALSE}

## Pulling only care responses

data_youth_care <- data_youth %>%
  filter(str_detect(ssi_choice, "CARE")) # filtering to those who chose care

## Calculating overall pfs mean for care

m_pfs_care <- round(mean(data_youth_care$pfs_mean, na.rm = TRUE), 2)

```

```{r calculating aggregated pfs mean for pp, include=FALSE}

## Pulling only pp responses

data_youth_pp <- data_youth %>%
  filter(str_detect(ssi_choice, "Personality")) # filtering to those who chose pp

## Calculating overall pfs mean for pp

m_pfs_pp <- round(mean(data_youth_pp$pfs_mean, na.rm = TRUE), 2)

```

```{r calculating aggregated pfs mean for rise, include=FALSE}

## Pulling only rise responses

data_youth_rise <- data_youth %>%
  filter(str_detect(ssi_choice, "RISE")) # filtering to those who chose rise

## Calculating overall pfs mean for rise

m_pfs_rise <- round(mean(data_youth_rise$pfs_mean, na.rm = TRUE), 2)

```

```{r t test bhs abc, include=FALSE}

## Trying this once before writing a function

library(stats)

## Computing paired t-test

t_abc_bhs <- t.test(data_youth_abc$post_bhs_mean, data_youth_abc$pre_bhs_mean, paired = TRUE)

## Saving p-value for report

abc_bhs_p_value <- t_abc_bhs$p.value

## Saving t-value for effect size calc

abc_bhs_t_value <- t_abc_bhs$statistic

## Saving n pairs for effect size calc

abc_bhs_n_pairs <- data_youth_abc %>%
  filter(!is.na(post_bhs_mean) & !is.na(pre_bhs_mean)) %>%
  select(post_bhs_mean, pre_bhs_mean) %>%
  nrow()

## Checking that all dfs have values in these columns (d03 no age var, d16 has no completers yet, d05 has no youth post-responses)

data_youth %>%
  select(data_id, pre_bhs_mean) %>%
  filter(!is.na(pre_bhs_mean)) %>%
  group_by(data_id) %>%
  tally()

data_youth %>%
  select(data_id, post_bhs_mean) %>%
  filter(!is.na(post_bhs_mean)) %>%
  group_by(data_id) %>%
  tally()

```

```{r t test effect size bhs abc, include=FALSE}

library(MOTE)

##  Calculating dz effect size, paired t-test

abc_bhs_dz_value <- round(d.dep.t.diff.t(abc_bhs_t_value, abc_bhs_n_pairs, a = 0.05)$d, 2)

```

```{r t test shs abc, include=FALSE}

library(stats)

## Computing paired t-test

t_abc_shs <- t.test(data_youth_abc$post_shs_mean, data_youth_abc$pre_shs_mean, paired = TRUE)

## Saving p-value for report

abc_shs_p_value <- t_abc_shs$p.value

## Saving t-value for effect size calc

abc_shs_t_value <- t_abc_shs$statistic

## Saving n pairs for effect size calc 

abc_shs_n_pairs <- data_youth_abc %>%
  filter(!is.na(post_shs_mean) & !is.na(pre_shs_mean)) %>%
  select(post_shs_mean, pre_shs_mean) %>%
  nrow()

## Checking that all dfs have values in these columns (d03 no age var, d16 has no completers yet, d05 has no youth post-responses)

data_youth %>%
  select(data_id, pre_shs_mean) %>%
  filter(!is.na(pre_shs_mean)) %>%
  group_by(data_id) %>%
  tally()

data_youth %>%
  select(data_id, post_shs_mean) %>%
  filter(!is.na(post_shs_mean)) %>%
  group_by(data_id) %>%
  tally()

```

```{r t test effect size shs abc, include=FALSE}

library(MOTE)

##  Calculating dz effect size, paired t-test

abc_shs_dz_value <- round(d.dep.t.diff.t(abc_shs_t_value, abc_shs_n_pairs, a = 0.05)$d, 2)

```

```{r t test hate abc, include=FALSE}

library(stats)

## Computing paired t-test

t_abc_hate <- t.test(data_youth_abc$post_self_hate_mean, data_youth_abc$pre_self_hate_mean, paired = TRUE)

## Saving p-value for report

abc_hate_p_value <- t_abc_hate$p.value

## Saving t-value for effect size calc

abc_hate_t_value <- t_abc_hate$statistic

## Saving n pairs for effect size calc 

abc_hate_n_pairs <- data_youth_abc %>%
  filter(!is.na(post_self_hate_mean) & !is.na(pre_self_hate_mean)) %>%
  select(post_self_hate_mean, pre_self_hate_mean) %>%
  nrow()

## Checking that all dfs have values in these columns (d03 no age var, d16 has no completers yet, d05 has no youth post-responses)

data_youth %>%
  select(data_id, pre_self_hate_mean) %>%
  filter(!is.na(pre_self_hate_mean)) %>%
  group_by(data_id) %>%
  tally()

data_youth %>%
  select(data_id, post_self_hate_mean) %>%
  filter(!is.na(post_self_hate_mean)) %>%
  group_by(data_id) %>%
  tally()

```

```{r t test effect size hate abc, include=FALSE}

library(MOTE)

##  Calculating dz effect size, paired t-test

abc_hate_dz_value <- round(d.dep.t.diff.t(abc_hate_t_value, abc_hate_n_pairs, a = 0.05)$d, 2)

```

```{r abc effect sizes list, include=FALSE}

## Saving dz values for report

abc_dz_values <- c(abc_bhs_dz_value, abc_shs_dz_value, abc_hate_dz_value)

```

```{r writing custom paired t-test function, include=FALSE}

library(tidyverse)
library(MOTE)
library(stats)

# Define the custom function
run_paired_t_test <- function(data, pre_col, post_col, prefix) {
  
  # Construct variable names dynamically for storage in global environment
  t_test_name <- paste0("t_", prefix)
  p_value_name <- paste0(prefix, "_p_value")
  t_value_name <- paste0(prefix, "_t_value")
  n_pairs_name <- paste0(prefix, "_n_pairs")
  dz_value_name <- paste0(prefix, "_dz_value")
  
  # Conduct the paired t-test
  t_test_result <- t.test(data[[post_col]], data[[pre_col]], paired = TRUE)
  
  # Save t-test results globally
  assign(t_test_name, t_test_result, envir = .GlobalEnv)
  
  # Save p-value and t-value globally
  assign(p_value_name, t_test_result$p.value, envir = .GlobalEnv)
  assign(t_value_name, t_test_result$statistic, envir = .GlobalEnv)
  
  # Calculate number of valid pairs (non-NA values in both columns)
  n_pairs <- data %>%
    filter(!is.na(.[[post_col]]) & !is.na(.[[pre_col]])) %>%
    nrow()
  assign(n_pairs_name, n_pairs, envir = .GlobalEnv)
  
  # Calculate the effect size (dz) and save it globally
  dz_value <- round(d.dep.t.diff.t(t_test_result$statistic, n_pairs, a = 0.05)$d, 2)
  assign(dz_value_name, dz_value, envir = .GlobalEnv)
  
  # Return a list of the calculated values
  return(list(
    t_test_result = get(t_test_name),
    p_value = get(p_value_name),
    t_value = get(t_value_name),
    n_pairs = get(n_pairs_name),
    dz_value = get(dz_value_name)
  ))
}

```

```{r running t tests for abc using custom function, include=FALSE}

# BHS
results_bhs <- run_paired_t_test(data_youth_abc, "pre_bhs_mean", "post_bhs_mean", "abc_bhs")
print(results_bhs)

# SHS
results_shs <- run_paired_t_test(data_youth_abc, "pre_shs_mean", "post_shs_mean", "abc_shs")
print(results_shs)

# Self-hate
results_hate <- run_paired_t_test(data_youth_abc, "pre_self_hate_mean", "post_self_hate_mean", "abc_hate")
print(results_hate)

# Combine all dz values into a single vector for reporting
abc_dz_values <- c(abc_bhs_dz_value, abc_shs_dz_value, abc_hate_dz_value)
print(abc_dz_values)

```

```{r running t tests for care using custom function, include=FALSE}

# BHS
results_bhs <- run_paired_t_test(data_youth_care, "pre_bhs_mean", "post_bhs_mean", "care_bhs")
print(results_bhs)

# SHS
results_shs <- run_paired_t_test(data_youth_care, "pre_shs_mean", "post_shs_mean", "care_shs")
print(results_shs)

# Self-hate
results_hate <- run_paired_t_test(data_youth_care, "pre_self_hate_mean", "post_self_hate_mean", "care_hate")
print(results_hate)

# Combine all dz values into a single vector for reporting
care_dz_values <- c(care_bhs_dz_value, care_shs_dz_value, care_hate_dz_value) # not including non-significant outcome results
print(care_dz_values)

```

```{r running t tests for pp using custom function, include=FALSE}

# BHS
results_bhs <- run_paired_t_test(data_youth_pp, "pre_bhs_mean", "post_bhs_mean", "pp_bhs")
print(results_bhs)

# SHS
results_shs <- run_paired_t_test(data_youth_pp, "pre_shs_mean", "post_shs_mean", "pp_shs")
print(results_shs)

# Self-hate
results_hate <- run_paired_t_test(data_youth_pp, "pre_self_hate_mean", "post_self_hate_mean", "pp_hate")
print(results_hate)

# Combine all dz values into a single vector for reporting
pp_dz_values <- c(pp_bhs_dz_value, pp_shs_dz_value, pp_hate_dz_value) # not including non-significant outcome results
print(pp_dz_values)

```

```{r running t tests for rise using custom function, include=FALSE}

# BHS
results_bhs <- run_paired_t_test(data_youth_rise, "pre_bhs_mean", "post_bhs_mean", "rise_bhs")
print(results_bhs)

# SHS
results_shs <- run_paired_t_test(data_youth_rise, "pre_shs_mean", "post_shs_mean", "rise_shs")
print(results_shs)

# Self-hate
results_hate <- run_paired_t_test(data_youth_rise, "pre_self_hate_mean", "post_self_hate_mean", "rise_hate")
print(results_hate)

# Combine all dz values into a single vector for reporting
rise_dz_values <- c(rise_bhs_dz_value, rise_shs_dz_value, rise_hate_dz_value) 
print(rise_dz_values)

```

```{r gender identity differs from sex, include=FALSE}

## Tallying number of cases where gender identity is different from sex assigned at birth

n_gender_differs_from_sex <- data_youth %>%
  filter(dem_gender_diff_sex == "Yes") %>%
  tally()

## Tallying number of cases where gender identity aligns with assigned sex

n_gender_same_as_sex <- data_youth %>%
  filter(dem_gender_diff_sex == "No") %>%
  tally()

## Calculating percentage of these cases, of everyone who started the survey

perc_gender_differs_from_sex <- round((n_gender_differs_from_sex / n_started_survey)*100,2)

perc_gender_same_as_sex <- round((n_gender_same_as_sex / n_started_survey)*100,2)

## Checking that all dfs have values in this column (d03 no age var)

data_youth %>%
  select(data_id, dem_gender_diff_sex) %>%
  filter(!is.na(dem_gender_diff_sex)) %>%
  group_by(data_id) %>%
  tally()

```

```{r perc sexual minority, include=FALSE}

## Tallying number of cases where gender identity is different from sex assigned at birth

n_sex_minority <- data_youth %>%
  select(dem_sex_orientation) %>%
  filter(!is.na(dem_sex_orientation) & 
           dem_sex_orientation != "Heterosexual/Straight" &
           dem_sex_orientation != "I do not want to respond") %>%
  tally()

## Tallying n straight folks

n_sex_straight <- data_youth %>%
  select(dem_sex_orientation) %>%
  filter(dem_sex_orientation == "Heterosexual/Straight") %>%
  tally()

## Calculating percentage of these cases, of everyone who started the survey

perc_sex_minority <- round((n_sex_minority / n_started_survey)*100,2)

perc_sex_straight <- round((n_sex_straight / n_started_survey)*100,2)

## Checking that all dfs have values in this column (d03 no age var)

data_youth %>%
  select(data_id, dem_sex_orientation) %>%
  filter(!is.na(dem_sex_orientation)) %>%
  group_by(data_id) %>%
  tally()

```

```{r perc racial minority, include=FALSE}

## Tallying number of cases where racial identity is not white or missing

n_racial_minority <- data_youth %>%
  select(contains("dem_race"), -contains("white"), -contains("hisp")) %>%
  filter(if_any(c(dem_race_asian, dem_race_black, dem_race_other), ~ . == "yes")) %>%
  tally()

## Tallying number of cases where ethnic identity is latine/hispanic

n_racial_latine_hisp <- data_youth %>%
  filter(dem_race_latin_hisp == "yes") %>%
  tally()

## Tallying number of cases where racial identity is white

n_racial_white <- data_youth %>%
  filter(dem_race_white == "yes") %>%
  tally()

## Calculating percentage of these cases, of everyone who started the survey

perc_racial_minority <- round((n_racial_minority / n_started_survey)*100,2)

perc_racial_latine_hisp <- round((n_racial_latine_hisp / n_started_survey)*100,2)

perc_racial_white <- round((n_racial_white / n_started_survey)*100,2)

## Checking that all dfs have values in this column (d03 no dem vars, d05 contains middle east specific ethnicity items)

data_youth %>%
  select(data_id, dem_race_white) %>%
  filter(!is.na(dem_race_white)) %>%
  group_by(data_id) %>%
  tally()

```

```{r calculating mfq descriptives, include=FALSE}

# Calculating n youth with elevated depression

n_youth_elev_dep <- data_youth %>%
  select(mfq_total) %>%
  filter(mfq_total >= 12) %>%
  nrow()

# Calculating perc youth with elevated depression

perc_youth_elev_dep <- round((n_youth_elev_dep / n_started_survey)*100, 2)

# Creating data frame

data_mfq_plot <- data_youth %>%
  select(mfq_total) %>%
  filter(!is.na(mfq_total))

mfq_mean <- data_mfq_plot %>%
  summarize(mfq_mean = round(mean(mfq_total, na.rm = TRUE), 2))

```

```{r calculating access to support descriptives, include=FALSE}

# Calculating n youth with unmet mental health needs

n_youth_unmet_mh_need <- data_youth %>%
  select(dem_receive_support) %>%
  filter(dem_receive_support == "no, but I have wanted to get support before") %>%
  nrow()

# Calculating n youth with data on past mental health access

n_youth_past_support <- data_youth %>%
  select(dem_receive_support) %>%
  filter(dem_receive_support == "no, but I have wanted to get support before" |
         str_detect(dem_receive_support, "yes, I have gotten support in the past")) %>%
  nrow()

# Calculating perc youth with history of unmet mh needs
# (perc no history of support, but they've wanted support;
# out of those who didn't get and did get support in the past)

perc_youth_unmet_mh_need <- round((n_youth_unmet_mh_need / n_youth_past_support)*100, 2)

# Calculating n youth with no history of mh support

n_youth_no_support <- data_youth %>%
  select(dem_receive_support) %>%
  filter(dem_receive_support == "no, but I have wanted to get support before" |
        dem_receive_support == "no, and I have not wanted to get support before") %>%
  nrow()

# Calculating perc of this sample who had never accessed support

perc_youth_no_support <- round((n_youth_no_support / n_started_survey)*100, 2)

# Calculating n youth with elevated depressive symptoms
# and with no history of support

n_youth_no_support_w_depression <- data_youth %>%
  filter(dem_receive_support == "no, but I have wanted to get support before" |
         dem_receive_support == "no, and I have not wanted to get support before") %>%
  filter(mfq_total >= 12) %>%
  select(dem_receive_support, mfq_total) %>%
  nrow()

# Calculating perc youth with depression, without support

perc_youth_no_support_w_depression <- round((n_youth_no_support_w_depression / n_started_survey)*100, 2)

```

```{r, out.width = "300px", out.height = "102px", include=TRUE, echo=FALSE}

knitr::include_graphics("/Users/mallorydobias/Documents/R/yes_project/images/lsmh_nu_logo.png")

```

# Summary

**We develop digital, evidence-based youth mental health supports that make an impact at scale.** Each "Single-Session Intervention", or SSI, is designed as a standalone experience; in ~30-minutes, youth walk away with a concrete lesson, skill, or plan to make a difference for their mental health. We [published Project YES](https://www.schleiderlab.org/yes.html), an online platform to share our SSIs publicly.

**We reach youth who would otherwise go undetected and under-supported.** Everything is self-led, available online, 100% free, and anonymous. For youth experiencing acute concerns, we can offer personalized referrals to local and approved resources. Accessibility is our priority.

**We maximize the impact 30 minutes can make.** By focusing on core principles of evidence-based mental health intervention and psychotherapies (e.g., "you are capable of change", "your thoughts and feelings are connected"), we make the most of limited time. 

**Our work is backed by scientific research.** In gold standard [randomized controlled trials](https://www.nature.com/articles/s41562-021-01235-0), our interventions improve key mental health outcomes, like reducing hopelessness and boosting youth's sense of agency, right away. They also reduce mental health symptoms three months later.

**Here we share positive results from >5,500 youth across the globe who have tried our open-access SSIs**. From before to after trying an SSI online, youth report improvements on key mental health outcomes (decreased hopelessness, increased agency, decreased self-hate).

# Do Our SSIs Work?

We share results from three of our open-access SSIs, currently offered on our [Project YES platform](https://www.schleiderlab.org/yes.html):

+ *ABC Project*: A behavioral activation activity, where youth learn how to take action to manage their mood
+ *Project CARE*: A self-compassion activity, where youth learn steps to be kinder to themselves
+ *Project Personality*: A growth mindset activity, where youth learn about their power to change

```{r, out.width = "780px", out.height = "240px", include=TRUE, echo=FALSE}

knitr::include_graphics("/Users/mallorydobias/Documents/R/yes_project/images/all_ssis_logo.png")

```

**All three SSIs show improvements in key mental health outcomes**, from before to after completing an activity:

+ **Reduced hopelessness** (e.g., less thinking that the future is dark and unlikely to improve)
+ **Increased agency** (e.g., increased belief in one's capability to reach goals and solve problems) 
+ **Reduced self-hate** (e.g., less feelings of shame and disgust with oneself)

```{r plot setup, include=FALSE, warning=FALSE}

## Loading required packages

library(tidyverse)
library(ggridges)
library(showtext)

## Setting up fonts

font_add_google(name = "Noto Sans",
                family = "noto sans")

showtext::showtext_auto()

```

```{r t test results abc bhs, echo=FALSE}

# t_abc_bhs # full results here

# Pulling table values

data_t_abc_bhs <- broom::tidy(t_abc_bhs) %>%
  select(statistic, parameter, p.value) %>%
  rename(df = parameter) %>%
  mutate(t = round(statistic, 2)) %>%
  mutate(dz = abc_bhs_dz_value,
         abc_test = "Hopelessness") %>%
  select(abc_test, t, df, p.value, dz)

```

```{r visualizing pre-post bhs abc setup, include=FALSE}

## Selecting pre and post vars for abc

pre_post_bhs_abc <- data_youth %>% 
  filter(str_detect(ssi_started, "A.B.C.")) %>%
  dplyr::select(pre_bhs_mean, post_bhs_mean)

# Converting to long data format

pre_post_bhs_abc_long <- pivot_longer(pre_post_bhs_abc, 
                                           cols = contains("mean"), 
                                           names_to = "timing", 
                                           values_to = "hopelessness")

##  Renaming for plot

plot_data_bhs_abc <- pre_post_bhs_abc_long %>% 
  mutate(timing = case_when(str_detect(timing, "pre") ~ "Before",
         str_detect(timing, "post") ~ "After",
         is.na(timing) ~ NA_character_))

```

```{r writing plot function for future plots, include=FALSE}

## Writing a function for future plot setup

process_plot_data <- function(data, ssi_string, pre_var, post_var, outcome_label) {
  # Select pre and post variables based on the ssi string
  pre_post_outcome <- data_youth %>%
    filter(str_detect(ssi_started, ssi_string)) %>%
    dplyr::select(contains(pre_var), 
                  contains(post_var))
  
  # Convert to long data format
  pre_post_outcome_long <- pre_post_outcome %>%
    pivot_longer(cols = contains("mean"), 
                 names_to = "timing", 
                 values_to = outcome_label)
  
  # Mutate 'timing' to label pre/post as 'Before'/'After'
  plot_data <- pre_post_outcome_long %>%
    mutate(timing = case_when(
      str_detect(timing, "pre") ~ "Before",
      str_detect(timing, "post") ~ "After",
      is.na(timing) ~ NA_character_
    ))
  
  return(plot_data)
}

```

```{r running custom plot function on abc bhs data, include=FALSE}

## Running plot setup function

plot_data_bhs_abc_function <- process_plot_data(data_youth, "A.B.C.", "pre_bhs_mean", "post_bhs_mean", "hopelessness")

```

```{r checking data frames are identical with and without function, include=FALSE}

identical(plot_data_bhs_abc, plot_data_bhs_abc_function) # true if processed data is identical using function

```

```{r visualizing pre-post bhs abc, include=FALSE, warning=FALSE}

## Plotting

plot_abc_bhs <- plot_data_bhs_abc_function %>%
  ggplot(aes(x = hopelessness, y = timing, fill = timing, color = timing)) +
  geom_density_ridges(alpha = 0.4,
                      jittered_points = TRUE,
                      position = "raincloud") +
  scale_fill_manual(values = c("#32A2A0", "grey")) +
  scale_color_manual(values = c("#32A2A0", "grey")) +
  scale_x_continuous(limits = c(0, 3)) +  # Set x-axis limits
  theme_light() +
  theme(legend.position = "none",
        text = element_text(family = "noto sans"),
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white")) +
  labs(x = "Hopelessness", y = " ")

```

```{r t test results abc shs, echo=FALSE}

# t_abc_shs # full results here

# Pulling table values

data_t_abc_shs <- broom::tidy(t_abc_shs) %>%
  select(statistic, parameter, p.value) %>%
  rename(df = parameter) %>%
  mutate(t = round(statistic, 2)) %>%
  mutate(dz = abc_shs_dz_value,
         abc_test = "Agency") %>%
  select(abc_test, t, df, p.value, dz)

```

```{r running custom plot function on abc shs data, include=FALSE}

## Running plot setup function

plot_data_shs_abc_function <- process_plot_data(data_youth, "A.B.C.", "pre_shs_mean", "post_shs_mean", "hope")

```

```{r visualizing pre-post shs abc, include=FALSE, warning=FALSE}

## Plotting

plot_abc_shs <- plot_data_shs_abc_function %>%
  ggplot(aes(x = hope, y = timing, fill = timing, color = timing)) +
  geom_density_ridges(alpha = 0.4,
                      jittered_points = TRUE,
                      position = "raincloud") +
  scale_fill_manual(values = c("#32A2A0", "grey")) +
  scale_color_manual(values = c("#32A2A0", "grey")) +
  scale_x_continuous(limits = c(1, 8)) +  # Set x-axis limits
  theme_light() +
  theme(legend.position = "none",
        text = element_text(family = "noto sans"),
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white")) +
  labs(x = "Agency", y = " ")

```

```{r t test results abc hate, echo=FALSE}

# t_abc_hate # full results here

# Pulling table values

data_t_abc_hate <- broom::tidy(t_abc_hate) %>%
  select(statistic, parameter, p.value) %>%
  rename(df = parameter) %>%
  mutate(t = round(statistic, 2)) %>%
  mutate(dz = abc_hate_dz_value,
         abc_test = "Self-Hate") %>%
  select(abc_test, t, df, p.value, dz)

```

```{r running custom plot function on abc hate data, include=FALSE}

## Running plot setup function

plot_data_hate_abc_function <- process_plot_data(data_youth, "A.B.C.", "pre_self_hate_mean", "post_self_hate_mean", "hate")

```

```{r visualizing pre-post hate abc, include=FALSE, warning=FALSE}

## Plotting

plot_abc_hate <- plot_data_hate_abc_function %>%
  ggplot(aes(x = hate, y = timing, fill = timing, color = timing)) +
  geom_density_ridges(alpha = 0.4,
                      jittered_points = TRUE,
                      position = "raincloud") +
  scale_fill_manual(values = c("#32A2A0", "grey")) +
  scale_color_manual(values = c("#32A2A0", "grey")) +
  scale_x_continuous(limits = c(1, 7)) +  # Set x-axis limits
  theme_light() +
  theme(legend.position = "none",
        text = element_text(family = "noto sans"),
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white")) +
  labs(x = "Self-Hate", y = " ")

```

```{r combining abc pre post outcomes plots, include=FALSE, warning=FALSE, message=FALSE}

## Plotting all pre post outcomes for abc

plots_abc <- plot_abc_bhs + plot_abc_shs + plot_abc_hate +
  plot_annotation(title = "Outcomes before vs after ABC Project",
                  theme = theme(plot.title = element_text(hjust = 0.5)),
                  caption = "Larger values within each plot (further right) are greater hopelessness, agency, self-hate.
                  Left plot = hopelessness scores (BHS) before and after ABC;
                  Middle plot = agency scores (SHS) before and after ABC;
                  Right plot = self-hate scores before and after ABC.")

plots_abc

```

```{r change abc hopeless, include=FALSE}

# Calculating number a lot or little less hopeless

n_abc_lot_little_less_hopeless <- data_youth_abc %>%
  filter(perc_change_hope == "A lot less hopeless" | perc_change_hope == "A little less hopeless") %>%
  nrow()

# Calculating total responses to that item

n_abc_answered_hopeless <- data_youth_abc %>%
  filter(!is.na(perc_change_hope)) %>%
  nrow()

# Calculating percentage who answered a lot or little less hopeless

perc_abc_lot_little_less_hopeless <- round((n_abc_lot_little_less_hopeless / n_abc_answered_hopeless)*100, 2)

```

```{r printing abc change hopelessness, include=FALSE}

perc_abc_lot_little_less_hopeless

```

```{r plotting abc change hopelessness, warning=FALSE, message=FALSE, include=FALSE}

# Creating df

data_abc_plot_change_hope <- data_youth_abc %>%
  filter(!is.na(perc_change_hope)) %>%
  select(perc_change_hope)

# Setting a group order

custom_order <- c("A lot less hopeless", "A little less hopeless", "The same amount of hopeless",
                  "A little more hopeless", "Much more hopeless")

# Convert to a factor with the specified order

data_abc_plot_change_hope_mutated <- data_abc_plot_change_hope %>%
  mutate(perc_change_hope = factor(data_abc_plot_change_hope$perc_change_hope, levels = custom_order))

# Plotting 

plot_abc_change_hopeless <- ggplot(data_abc_plot_change_hope_mutated, aes(x = perc_change_hope)) +  
  geom_histogram(stat="count", fill = "#32A2A0", alpha = 0.8) +  
  theme_light() +
  theme(legend.position = "none",
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +  # rotate x-axis labels
  plot_annotation(title = "Compared to before (ABC Project), how hopeless do you feel right now?") +
  labs(x = "", y = "frequency")

plot_abc_change_hopeless

```

```{r change abc problem solving, include=FALSE}

# Calculating number a lot or little more able to solve problems

n_abc_lot_little_more_prob <- data_youth_abc %>%
  filter(perc_change_prob == "A lot more able to solve the problems" | 
           perc_change_prob == "A little more able to solve the problems") %>%
  nrow()

# Calculating total responses to that item

n_abc_answered_prob <- data_youth_abc %>%
  filter(!is.na(perc_change_prob)) %>%
  nrow()

# Calculating percentage who answered a lot or little less hopeless

perc_abc_lot_little_more_prob <- round((n_abc_lot_little_more_prob / n_abc_answered_prob)*100, 2)

```

```{r printing abc change problem solving, include=FALSE}

perc_abc_lot_little_more_prob

```

```{r plotting abc change problem solving, warning=FALSE, message=FALSE, include=FALSE}

# Creating df

data_abc_plot_change_prob <- data_youth_abc %>%
  filter(!is.na(perc_change_prob)) %>%
  select(perc_change_prob) %>%
  mutate(perc_change_prob = case_when(perc_change_prob == "A lot more able to solve the problems" ~ "A lot more able",
                                      perc_change_prob == "A little more able to solve the problems" ~ "A little more able",
                                      perc_change_prob == "The same amount able to solve the problems" ~ "The same amount able",
                                      perc_change_prob == "A little less able to solve the problems" ~ "A little less able",
                                      perc_change_prob == "Much less able to solve the problems" ~ "Much less able",
                                      TRUE ~ perc_change_prob))

# Setting a group order

custom_order <- c("A lot more able", "A little more able", "The same amount able", 
                  "A little less able", "Much less able")

# Convert to a factor with the specified order

data_abc_plot_change_prob_mutated <- data_abc_plot_change_prob %>%
  mutate(perc_change_prob = factor(data_abc_plot_change_prob$perc_change_prob, levels = custom_order))

# Plotting 

plot_abc_change_prob <- ggplot(data_abc_plot_change_prob_mutated, aes(x = perc_change_prob)) +  
  geom_histogram(stat="count", fill = "#32A2A0", alpha = 0.8) +  
  theme_light() +
  theme(legend.position = "none",
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +  # rotate x-axis labels
  plot_annotation(title = "Compared to before (ABC Project), how able are you to solve your problems?") +
  labs(x = "", y = "frequency")

plot_abc_change_prob

```

```{r t test results care bhs, echo=FALSE}

# t_care_bhs # full results here

# Pulling table values

data_t_care_bhs <- broom::tidy(t_care_bhs) %>%
  select(statistic, parameter, p.value) %>%
  rename(df = parameter) %>%
  mutate(t = round(statistic, 2)) %>%
  mutate(dz = care_bhs_dz_value,
         care_test = "Hopelessness") %>%
  select(care_test, t, df, p.value, dz)

```

```{r running custom plot function on care bhs data, include=FALSE}

## Running plot setup function

plot_data_bhs_care_function <- process_plot_data(data_youth, "C.A.R.E", "pre_bhs_mean", "post_bhs_mean", "hopelessness")

```

```{r visualizing pre-post bhs care, include=FALSE, warning=FALSE}

## Plotting

plot_care_bhs <- plot_data_bhs_care_function %>%
  ggplot(aes(x = hopelessness, y = timing, fill = timing, color = timing)) +
  geom_density_ridges(alpha = 0.4,
                      jittered_points = TRUE,
                      position = "raincloud") +
  scale_fill_manual(values = c("#A52B4D", "grey")) +
  scale_color_manual(values = c("#A52B4D", "grey")) +
  scale_x_continuous(limits = c(0, 3)) +  # Set x-axis limits
  theme_light() +
  theme(legend.position = "none",
        text = element_text(family = "noto sans"),
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white")) +
  labs(x = "Hopelessness", y = " ")

```

```{r t test results care shs, echo=FALSE}

# t_care_shs # full results here

# Pulling table values

data_t_care_shs <- broom::tidy(t_care_shs) %>%
  select(statistic, parameter, p.value) %>%
  rename(df = parameter) %>%
  mutate(t = round(statistic, 2)) %>%
  mutate(dz = care_shs_dz_value,
         care_test = "Agency") %>%
  select(care_test, t, df, p.value, dz)

```

```{r running custom plot function on care shs data, include=FALSE}

## Running plot setup function

plot_data_shs_care_function <- process_plot_data(data_youth, "C.A.R.E", "pre_shs_mean", "post_shs_mean", "hope")

```

```{r visualizing pre-post shs care, include=FALSE, warning=FALSE}

## Plotting

plot_care_shs <- plot_data_shs_care_function %>%
  ggplot(aes(x = hope, y = timing, fill = timing, color = timing)) +
  geom_density_ridges(alpha = 0.4,
                      jittered_points = TRUE,
                      position = "raincloud") +
  scale_fill_manual(values = c("#A52B4D", "grey")) +
  scale_color_manual(values = c("#A52B4D", "grey")) +
  scale_x_continuous(limits = c(1, 8)) +  # Set x-axis limits
  theme_light() +
  theme(legend.position = "none",
        text = element_text(family = "noto sans"),
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white")) +
  labs(x = "Agency", y = " ")

```

```{r t test results care hate, echo=FALSE}

# t_care_hate # full results here

# Pulling table values

data_t_care_hate <- broom::tidy(t_care_hate) %>%
  select(statistic, parameter, p.value) %>%
  rename(df = parameter) %>%
  mutate(t = round(statistic, 2)) %>%
  mutate(dz = care_hate_dz_value,
         care_test = "Self-Hate") %>%
  select(care_test, t, df, p.value, dz)

```

```{r running custom plot function on care hate data, include=FALSE}

## Running plot setup function

plot_data_hate_care_function <- process_plot_data(data_youth, "C.A.R.E", "pre_self_hate_mean", "post_self_hate_mean", "hate")

```

```{r visualizing pre-post hate care, include=FALSE, warning=FALSE}

## Plotting

plot_care_hate <- plot_data_hate_care_function %>%
  ggplot(aes(x = hate, y = timing, fill = timing, color = timing)) +
  geom_density_ridges(alpha = 0.4,
                      jittered_points = TRUE,
                      position = "raincloud") +
  scale_fill_manual(values = c("#A52B4D", "grey")) +
  scale_color_manual(values = c("#A52B4D", "grey")) +
  scale_x_continuous(limits = c(1, 7)) +  # Set x-axis limits
  theme_light() +
  theme(legend.position = "none",
        text = element_text(family = "noto sans"),
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white")) +
  labs(x = "Self-Hate", y = " ")

```

```{r combining care pre post outcomes plots, include=FALSE, warning=FALSE, message=FALSE}

## Plotting all pre post outcomes for care

plots_care <- plot_care_bhs + plot_care_shs + plot_care_hate +
  plot_annotation(title = "Outcomes before vs after Project CARE",
                  theme = theme(plot.title = element_text(hjust = 0.5)),
                  caption = "Larger values within each plot (further right) are greater hopelessness, agency, self-hate.
                  Left plot = hopelessness scores (BHS) before and after CARE;
                  Middle plot = agency scores (SHS) before and after CARE;
                  Right plot = self-hate scores before and after CARE.")

plots_care

```

```{r change care hopeless, include=FALSE}

# Calculating number a lot or little less hopeless

n_care_lot_little_less_hopeless <- data_youth_care %>%
  filter(perc_change_hope == "A lot less hopeless" | perc_change_hope == "A little less hopeless") %>%
  nrow()

# Calculating total responses to that item

n_care_answered_hopeless <- data_youth_care %>%
  filter(!is.na(perc_change_hope)) %>%
  nrow()

# Calculating percentage who answered a lot or little less hopeless

perc_care_lot_little_less_hopeless <- round((n_care_lot_little_less_hopeless / n_care_answered_hopeless)*100, 2)

```

```{r printing care change hopelessness, include=FALSE}

perc_care_lot_little_less_hopeless

```

```{r plotting care change hopelessness, warning=FALSE, message=FALSE, include=FALSE}

# Creating df

data_care_plot_change_hope <- data_youth_care %>%
  filter(!is.na(perc_change_hope)) %>%
  select(perc_change_hope)

# Setting a group order

custom_order <- c("A lot less hopeless", "A little less hopeless", "The same amount of hopeless",
                  "A little more hopeless", "Much more hopeless")

# Convert to a factor with the specified order

data_care_plot_change_hope_mutated <- data_care_plot_change_hope %>%
  mutate(perc_change_hope = factor(data_care_plot_change_hope$perc_change_hope, levels = custom_order))

# Plotting 

plot_care_change_hopeless <- ggplot(data_care_plot_change_hope_mutated, aes(x = perc_change_hope)) +  
  geom_histogram(stat="count", fill = "#A52B4D", alpha = 0.8) +  
  theme_light() +
  theme(legend.position = "none",
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +  # rotate x-axis labels
  plot_annotation(title = "Compared to before (Project CARE), how hopeless do you feel right now?") +
  labs(x = "", y = "frequency")

plot_care_change_hopeless

```

```{r change care problem solving, include=FALSE}

# Calculating number a lot or little more able to solve problems

n_care_lot_little_more_prob <- data_youth_care %>%
  filter(perc_change_prob == "A lot more able to solve the problems" | 
           perc_change_prob == "A little more able to solve the problems") %>%
  nrow()

# Calculating total responses to that item

n_care_answered_prob <- data_youth_care %>%
  filter(!is.na(perc_change_prob)) %>%
  nrow()

# Calculating percentage who answered a lot or little less hopeless

perc_care_lot_little_more_prob <- round((n_care_lot_little_more_prob / n_care_answered_prob)*100, 2)

```

```{r printing care change problem solving, include=FALSE}

perc_care_lot_little_more_prob

```

```{r plotting care change problem solving, warning=FALSE, message=FALSE, include=FALSE}

# Creating df

data_care_plot_change_prob <- data_youth_care %>%
  filter(!is.na(perc_change_prob)) %>%
  select(perc_change_prob) %>%
  mutate(perc_change_prob = case_when(perc_change_prob == "A lot more able to solve the problems" ~ "A lot more able",
                                      perc_change_prob == "A little more able to solve the problems" ~ "A little more able",
                                      perc_change_prob == "The same amount able to solve the problems" ~ "The same amount able",
                                      perc_change_prob == "A little less able to solve the problems" ~ "A little less able",
                                      perc_change_prob == "Much less able to solve the problems" ~ "Much less able",
                                      TRUE ~ perc_change_prob))

# Setting a group order

custom_order <- c("A lot more able", "A little more able", "The same amount able", 
                  "A little less able", "Much less able")

# Convert to a factor with the specified order

data_care_plot_change_prob_mutated <- data_care_plot_change_prob %>%
  mutate(perc_change_prob = factor(data_care_plot_change_prob$perc_change_prob, levels = custom_order))

# Plotting 

plot_care_change_prob <- ggplot(data_care_plot_change_prob_mutated, aes(x = perc_change_prob)) +  
  geom_histogram(stat="count", fill = "#A52B4D", alpha = 0.8) +  
  theme_light() +
  theme(legend.position = "none",
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +  # rotate x-axis labels
  plot_annotation(title = "Compared to before (Project CARE), how able are you to solve your problems?") +
  labs(x = "", y = "frequency")

plot_care_change_prob

```

```{r t test results pp bhs, echo=FALSE}

# t_pp_bhs # full results here

# Pulling table values

data_t_pp_bhs <- broom::tidy(t_pp_bhs) %>%
  select(statistic, parameter, p.value) %>%
  rename(df = parameter) %>%
  mutate(t = round(statistic, 2)) %>%
  mutate(dz = pp_bhs_dz_value,
         pp_test = "Hopelessness") %>%
  select(pp_test, t, df, p.value, dz)

```

```{r running custom plot function on pp bhs data, include=FALSE}

## Running plot setup function

plot_data_bhs_pp_function <- process_plot_data(data_youth, "Personality", "pre_bhs_mean", "post_bhs_mean", "hopelessness")

```

```{r visualizing pre-post bhs pp, include=FALSE, warning=FALSE}

## Plotting

plot_pp_bhs <- plot_data_bhs_pp_function %>%
  ggplot(aes(x = hopelessness, y = timing, fill = timing, color = timing)) +
  geom_density_ridges(alpha = 0.4,
                      jittered_points = TRUE,
                      position = "raincloud") +
  scale_fill_manual(values = c("#3F9CF5", "grey")) +
  scale_color_manual(values = c("#3F9CF5", "grey")) +
  scale_x_continuous(limits = c(0, 3)) +  # Set x-axis limits
  theme_light() +
  theme(legend.position = "none",
        text = element_text(family = "noto sans"),
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white")) +
  labs(x = "Hopelessness", y = " ")

```

```{r t test results pp shs, echo=FALSE}

# t_pp_shs # full results here

# Pulling table values

data_t_pp_shs <- broom::tidy(t_pp_shs) %>%
  select(statistic, parameter, p.value) %>%
  rename(df = parameter) %>%
  mutate(t = round(statistic, 2)) %>%
  mutate(dz = pp_shs_dz_value,
         pp_test = "Agency") %>%
  select(pp_test, t, df, p.value, dz)

```

```{r running custom plot function on pp shs data, include=FALSE}

## Running plot setup function

plot_data_shs_pp_function <- process_plot_data(data_youth, "Personality", "pre_shs_mean", "post_shs_mean", "hope")

```

```{r visualizing pre-post shs pp, include=FALSE, warning=FALSE}

## Plotting

plot_pp_shs <- plot_data_shs_pp_function %>%
  ggplot(aes(x = hope, y = timing, fill = timing, color = timing)) +
  geom_density_ridges(alpha = 0.4,
                      jittered_points = TRUE,
                      position = "raincloud") +
  scale_fill_manual(values = c("#3F9CF5", "grey")) +
  scale_color_manual(values = c("#3F9CF5", "grey")) +
  scale_x_continuous(limits = c(1, 8)) +  # Set x-axis limits
  theme_light() +
  theme(legend.position = "none",
        text = element_text(family = "noto sans"),
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white")) +
  labs(x = "Agency", y = " ")

```

```{r t test results pp hate, echo=FALSE}

# t_pp_hate # full results here

# Pulling table values

data_t_pp_hate <- broom::tidy(t_pp_hate) %>%
  select(statistic, parameter, p.value) %>%
  rename(df = parameter) %>%
  mutate(t = round(statistic, 2)) %>%
  mutate(dz = pp_hate_dz_value,
         pp_test = "Self-Hate") %>%
  select(pp_test, t, df, p.value, dz)

```

```{r running custom plot function on pp hate data, include=FALSE}

## Running plot setup function

plot_data_hate_pp_function <- process_plot_data(data_youth, "Personality", "pre_self_hate_mean", "post_self_hate_mean", "hate")

```

```{r visualizing pre-post hate pp, include=FALSE, warning=FALSE}

## Plotting

plot_pp_hate <- plot_data_hate_pp_function %>%
  ggplot(aes(x = hate, y = timing, fill = timing, color = timing)) +
  geom_density_ridges(alpha = 0.4,
                      jittered_points = TRUE,
                      position = "raincloud") +
  scale_fill_manual(values = c("#3F9CF5", "grey")) +
  scale_color_manual(values = c("#3F9CF5", "grey")) +
  scale_x_continuous(limits = c(1, 7)) +  # Set x-axis limits
  theme_light() +
  theme(legend.position = "none",
        text = element_text(family = "noto sans"),
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white")) +
  labs(x = "Self-Hate", y = " ")

```

```{r combining pp pre post outcomes plots, include=FALSE, warning=FALSE, message=FALSE}

## Plotting all pre post outcomes for pp

plots_pp <- plot_pp_bhs + plot_pp_shs + plot_pp_hate +
   plot_annotation(title = "Outcomes before vs after Project Personality",
                  theme = theme(plot.title = element_text(hjust = 0.5)),
                  caption = "Larger values within each plot (further right) are greater hopelessness, agency, self-hate.
                  Left plot = hopelessness scores (BHS) before and after Personality;
                  Middle plot = agency scores (SHS) before and after Personality;
                  Right plot = self-hate scores before and after Personality.")

plots_pp

```

```{r change pp hopeless, include=FALSE}

# Calculating number a lot or little less hopeless

n_pp_lot_little_less_hopeless <- data_youth_pp %>%
  filter(perc_change_hope == "A lot less hopeless" | perc_change_hope == "A little less hopeless") %>%
  nrow()

# Calculating total responses to that item

n_pp_answered_hopeless <- data_youth_pp %>%
  filter(!is.na(perc_change_hope)) %>%
  nrow()

# Calculating percentage who answered a lot or little less hopeless

perc_pp_lot_little_less_hopeless <- round((n_pp_lot_little_less_hopeless / n_pp_answered_hopeless)*100, 2)

```

```{r printing pp change hopelessness, include=FALSE}

perc_pp_lot_little_less_hopeless

```

```{r plotting pp change hopelessness, warning=FALSE, message=FALSE, include=FALSE}

# Creating df

data_pp_plot_change_hope <- data_youth_pp %>%
  filter(!is.na(perc_change_hope)) %>%
  select(perc_change_hope)

# Setting a group order

custom_order <- c("A lot less hopeless", "A little less hopeless", "The same amount of hopeless",
                  "A little more hopeless", "Much more hopeless")

# Convert to a factor with the specified order

data_pp_plot_change_hope_mutated <- data_pp_plot_change_hope %>%
  mutate(perc_change_hope = factor(data_pp_plot_change_hope$perc_change_hope, levels = custom_order))

# Plotting 

plot_pp_change_hopeless <- ggplot(data_pp_plot_change_hope_mutated, aes(x = perc_change_hope)) +  
  geom_histogram(stat="count", fill = "#3F9CF5", alpha = 0.8) +  
  theme_light() +
  theme(legend.position = "none",
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +  # rotate x-axis labels
  plot_annotation(title = "Compared to before (Project Personality), how hopeless do you feel right now?") +
  labs(x = "", y = "frequency")

plot_pp_change_hopeless

```

```{r change pp problem solving, include=FALSE}

# Calculating number a lot or little more able to solve problems

n_pp_lot_little_more_prob <- data_youth_pp %>%
  filter(perc_change_prob == "A lot more able to solve the problems" | 
           perc_change_prob == "A little more able to solve the problems") %>%
  nrow()

# Calculating total responses to that item

n_pp_answered_prob <- data_youth_pp %>%
  filter(!is.na(perc_change_prob)) %>%
  nrow()

# Calculating percentage who answered a lot or little less hopeless

perc_pp_lot_little_more_prob <- round((n_pp_lot_little_more_prob / n_pp_answered_prob)*100, 2)

```

```{r printing pp change problem solving, include=FALSE}

perc_pp_lot_little_more_prob

```

```{r plotting pp change problem solving, warning=FALSE, message=FALSE, include=FALSE}

# Creating df

data_pp_plot_change_prob <- data_youth_pp %>%
  filter(!is.na(perc_change_prob)) %>%
  select(perc_change_prob) %>%
  mutate(perc_change_prob = case_when(perc_change_prob == "A lot more able to solve the problems" ~ "A lot more able",
                                      perc_change_prob == "A little more able to solve the problems" ~ "A little more able",
                                      perc_change_prob == "The same amount able to solve the problems" ~ "The same amount able",
                                      perc_change_prob == "A little less able to solve the problems" ~ "A little less able",
                                      perc_change_prob == "Much less able to solve the problems" ~ "Much less able",
                                      TRUE ~ perc_change_prob))

# Setting a group order

custom_order <- c("A lot more able", "A little more able", "The same amount able", 
                  "A little less able", "Much less able")

# Convert to a factor with the specified order

data_pp_plot_change_prob_mutated <- data_pp_plot_change_prob %>%
  mutate(perc_change_prob = factor(data_pp_plot_change_prob$perc_change_prob, levels = custom_order))

# Plotting 

plot_pp_change_prob <- ggplot(data_pp_plot_change_prob_mutated, aes(x = perc_change_prob)) +  
  geom_histogram(stat="count", fill = "#3F9CF5", alpha = 0.8) +  
  theme_light() +
  theme(legend.position = "none",
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +  # rotate x-axis labels
  plot_annotation(title = "Compared to before (Project Personality), how able are you to solve your problems?") +
  labs(x = "", y = "frequency")

plot_pp_change_prob

```

In the plot below, grey curves are outcome scores before each intervention, and colored curves are outcome scores after each intervention. Larger scores (when curves are further to the right) mean greater hopelessness, greater agency, and greater self-hate respectively. For all SSIs (ABC Project = top row, Project CARE = middle row, Project Personality = bottom row), colored curves show improvements in outcomes... **lower hopelessness, higher agency, and lower self-hate after the intervention**.

These results are exactly what we'd expect, given our [rigorous clinical trial research results](https://www.nature.com/articles/s41562-021-01235-0).

```{r combining all pre post outcomes plots, echo=FALSE, warning=FALSE, message=FALSE}

library(patchwork)

# Combine the plots vertically
plots_all <- plots_abc / plots_care / plots_pp  + 
  plot_annotation(
    title = "Outcomes before and after all SSIs",
    caption = "hopelessness, agency, self-hate before + after ABC (green/top), CARE (red/middle), and Project Personality (blue/bottom)"
  )

# Show the combined plot
plots_all

```

Compared to before completing an activity...

+ **`r round(perc_pp_lot_little_less_hopeless,0)` to `r round(perc_abc_lot_little_less_hopeless,0)`%** were "a lot" or "a little" less hopeless
+ **`r round(perc_pp_lot_little_more_prob,0)` to `r round(perc_abc_lot_little_more_prob,0)`%** were "a lot" or "a little" more able to solve problems

In other words, the math checks out. After completing a free, 30-minute online, youth reported small to medium improvements on things like: believing they can solve problems and reach their goals, feeling less shame and disgust about themselves, and lessening beliefs that the future won't ever improve.

**See real testimonials from youth who visited our platform.** Project YES also helped teens feel less alone, kinder toward themselves, and capable of creating a personal action plan:

```{r, out.width = "600px", out.height = "600px", include=TRUE, echo=FALSE}

knitr::include_graphics("/Users/mallorydobias/Documents/R/yes_project/images/yes_quotes.png")

```

# Who Accessed Our SSIs?

Our Project YES resource has already reached a wide range of youth, across age and racial/ethnic identity. YES has also reached youth with high levels of depression symptoms.

## Age

```{r prepping for age tally, include=FALSE}

data_youth_age <- data_youth %>%
  select(dem_age)

```

```{r calculating age tally, include=FALSE}

## Prepping dataframe with age tallies; renaming is a bit weird here once % is calculated
## No need to add missing values here, since only one variable

age_tallies <- data_youth_age %>%
  select(age = dem_age) %>%
  group_by(age) %>%
  tally() %>%
  ungroup() %>%
  rename(count = n) %>%
  rowwise() %>%
  mutate(percentage = count / n_started_survey * 100) %>%
  mutate(percentage = round(percentage, 2)) %>%
  unnest(cols = c(percentage)) %>%
  rename(n = count, "%" = n)

```

```{r printing age tally, echo=FALSE}

rempsyc::nice_table(age_tallies)

```

## Race/Ethnicity

```{r adding missing values to race vars, include=FALSE}

## Accounting for missing values across all race variables

data_youth_race <- data_youth %>%
  filter(data_id != "d05") %>% # not counting d05 responses as missing data
  select(contains("race")) %>%
  mutate(dem_race_missing = case_when(
    if_all(everything(), is.na) ~ "yes",  # "yes" if all vars are NA mark as missing
    TRUE ~ "no"  # Otherwise, mark as "no"
  ))

```

```{r calculating race denominator, include=FALSE}

# saving custom denominator value

n_race_denominator <- nrow(data_youth_race)

```

```{r calculating race tallies, include=FALSE}

## Calculating race tallies

race_tallies <- data_youth_race %>%
  summarise(across(everything(), ~ sum(. == "yes" | . == "Yes", na.rm = TRUE))) %>% # Count "yes" in each column
  pivot_longer(cols = everything(), # Convert to long format
                 names_to = "variable", 
                 values_to = "count") %>%
  rowwise() %>%
  mutate(percentage = count / n_race_denominator * 100) %>% 
  mutate(percentage = round(percentage, 2)) %>% # Correct rounding
  unnest(cols = c(percentage)) %>% # Ensure percentage column is not nested
  mutate(variable = str_replace(variable, "dem_race_", "")) %>%
  rename(racial_ethnic_identity = variable) %>%
  rename(n = count) %>%
  rename("%" = percentage) %>%
  arrange(-n) %>%
  mutate(racial_ethnic_identity = case_when(racial_ethnic_identity == "missing" ~ "Missing",
                                     racial_ethnic_identity == "white" ~ "White",
                                     racial_ethnic_identity == "latin_hisp" ~ "Latine/Hispanic",
                                     racial_ethnic_identity == "asian" ~ "Asian",
                                     racial_ethnic_identity == "black" ~ "Black",
                                     racial_ethnic_identity == "other" ~ "Another racial/ethnic identity not listed",
                                     TRUE ~ racial_ethnic_identity))

```

```{r printing race tally, echo=FALSE}

rempsyc::nice_table(race_tallies)

```

## Depression Scores

**Over a quarter of responses (`r perc_youth_elev_dep`%) reported elevated levels of depression symptoms.** This means *more than 1 in 4 youth who accessed our Project YES platform* were possibly experiencing clinical levels of things like loneliness, self-hate, low motivation, low concentration, and low mood.

Here, we plot depression scale scores, using the [Mood and Feelings Questionnaire (MFQ)](https://doi.org/10.1002/mpr.1610), across the entire youth sample.

```{r calculating proportion of teens elevated depression, include=FALSE}

perc_youth_elev_dep

```

```{r plotting mfq, echo=FALSE, warning=FALSE, message=FALSE}

# Convert mfq_category to a factor

data_mfq_plot$mfq_category <- as.factor((data_mfq_plot$mfq_total >= 12))

# Plotting mfq
plot_mfq <- ggplot(data_mfq_plot, aes(x = mfq_total, fill = mfq_category)) +  # conditional fill
  geom_histogram(binwidth = 1, alpha = 0.8) +
  scale_fill_manual(values = c("FALSE" = "#836EAA", "TRUE" = "#4E2A84")) +  # color for <12 and >=12
  geom_vline(aes(xintercept = mfq_mean$mfq_mean), color = "black", linetype = "solid", size = 0.5) +  # line
  scale_x_continuous(limits = c(0, 26)) +  # Set x-axis limits
  theme_light() +
  theme(legend.position = "none",
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white")) +
  plot_annotation(title = "Depression scale scores (MFQ) for all youth",
                  caption = paste("Higher scores (further right) mean greater depressive symptoms. 
                  Scores of 12 or higher suggest possible depression (dark purple); mean =", round(mfq_mean$mfq_mean, 2), "(solid line).")) +
  labs(x = "depression score", y = "frequency")

plot_mfq

```

## Treatment Access

**`r perc_youth_unmet_mh_need`% of youth responses reported a history of unmet need for mental health support.** Out of all responses that shared their past mental health treatment access, these responses said they wanted treatment they did not receive.

```{r showing unmet mental health need, include=FALSE}

perc_youth_no_support

```

```{r setting up to plot access to support, include=FALSE}

# Creating df for plot

data_access_plot <- data_youth %>%
  select(dem_receive_support) %>%
  filter(!is.na(dem_receive_support) & !str_detect(dem_receive_support, ",no")) %>% # dropping multiple conflicting responses
  filter(!is.na(dem_receive_support) & !str_detect(dem_receive_support, "now") & 
           !str_detect(dem_receive_support, "not wanted")) %>% # dropping irrelevant responses
  mutate(dem_receive_support = str_replace(dem_receive_support, "yes, I have gotten support in the past", "yes, past support"),
         dem_receive_support = str_replace(dem_receive_support, "no, but I have wanted to get support before", "no past support (but wanted it)"))
  
# Setting a group order

custom_order <- c("no past support (but wanted it)", "yes, past support")

# Convert to a factor with the specified order

data_access_plot_mutated <- data_access_plot %>%
  mutate(dem_receive_support = factor(data_access_plot$dem_receive_support, levels = custom_order))

```

```{r plotting access to support, echo=FALSE, warning=FALSE, message=FALSE}

# Plotting 

plot_access <- ggplot(data_access_plot_mutated, aes(x = dem_receive_support)) +  
  geom_histogram(stat="count", fill = "#4E2A84", alpha = 0.8) +  
  theme_light() +
  theme(legend.position = "none",
        title = element_text(size = 10),
        plot.background = element_rect(fill = "white")) +
        # axis.text.x = element_text(angle = 45, hjust = 1)) +  # rotate x-axis labels
  plot_annotation(title = "Have you gotten support for your emotional or mental health before?",
                  caption = paste("This question defined support as 'professional therapy, seeing a counselor, or seeing a doctor;
                                  Plot does not include missing values'")) +
  labs(x = "", y = "frequency")

plot_access

```

# Questions?

Email us with questions: jessica.schleider@northwestern.edu and mallory.dobias1@northwestern.edu.
