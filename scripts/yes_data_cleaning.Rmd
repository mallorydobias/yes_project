---
title: "yes_data_cleaning"
author: "Mallory Dobias"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: no
      smooth_scroll: no
  pdf_document:
    toc: yes
    toc_depth: '5'
  word_document:
    toc: yes
    toc_depth: '5'
geometry: margin=0.50in
---

```{r setup, include=FALSE}

## Setting up R

knitr::opts_chunk$set(echo = TRUE)

if(!require(pointblank)){install.packages('pointblank')}
library(pointblank) # installing and calling pointblank package early in Markdown

validate_rmd(summary = TRUE, log_to_file = FALSE) # allowing validation from pointblank package within Markdown

```

```{r, include=FALSE}

if(!require(here)){install.packages('here')}
library(here)

if(!require(janitor)){install.packages('janitor')}
library(janitor)

if(!require(dplyr)){install.packages('dplyr')}
library(dplyr)

if(!require(stringr)){install.packages('stringr')}
library(stringr)

if(!require(pointblank)){install.packages('pointblank')}
library(pointblank)

```

# Data Reading

```{r reading in data}

## Reading in NU English survey data

library(here) # places working directory at root of project folder

raw_data <- read.csv(here("data", "raw", "NU - YES - English - Questionnaires Optional_October 31, 2024_14.42.csv")) # directing to data from project folder root

# head(raw_data)

```

# Data Cleaning

## Cleaning Var Names

```{r removing first two Qualtrics metadata rows}

## Removing first two rows with Qualtrics metadata

data_sliced <- raw_data %>%
  dplyr::slice(-1,-2)

# head(data_sliced) # looks good

## checking Qualtrics metadata rows are removed

search_for_string <- "Date" # creating string to search for

data_sliced %>%
  filter(stringr::str_detect(StartDate, search_for_string)) %>%
  nrow() == 0 # true if "Date" metadata rows are no longer in this column of data frame

```

```{r creating tidy names}

## Cleaning var names

data_named <- data_sliced %>%
  janitor::clean_names()

# head(data_named)

## checking var names are now tidy

test_var_names <- tibble(col_names = names(data_named)) # creates data frame of names

test_var_names %>%
  filter(stringr::str_detect(col_names, "[A-Z]")) %>%
  nrow() == 0 # true if zero col names contain capital letters

```

```{r naming rise vars}

## Naming RISE vars

# first insert an underscore, then replace q vars with rise var name labels

data_rise_named <- data_named %>%
  rename_with(~str_replace(., "^q([0-9]+)", "q_\\1"), starts_with("q")) %>%
  rename_with(~ str_replace(., "^q_", "proj_rise_q_"), starts_with("q_"))

## checking rise vars are named correctly

test_rise_pre <- data_named %>%
  select(starts_with("q"), -questionnaires, -contains("text")) %>%
  rename_with(~ str_extract(., "\\d+")) %>% # extract digits from rise var names pre cleaning
  colnames()

test_rise_post <- data_rise_named %>%
  select(starts_with("proj_rise_"), -contains("commit"), -contains("text")) %>%
  rename_with(~ str_extract(., "\\d+")) %>% # extract digits from rise var names post cleaning
  colnames()

identical(test_rise_pre, test_rise_post) # true if renamed columns (except text cols) are identical to original cols

```

```{r checking rise var naming with pointblank, results='asis'}

## checking rise vars are named correctly

library(pointblank)

test_rise_naming_df <- tibble(test_rise_pre, test_rise_post) # creating a df for validation

# test_rise_naming <- create_agent(
#                         tbl = test_rise_naming_df,
#                         actions = warn_on_fail()) %>%
#                     col_vals_equal(vars(test_rise_pre), vars(test_rise_post)) %>%
#                     interrogate()
# 
# print(test_rise_naming)

```

```{r validate = TRUE, include = TRUE}

test_rise_naming_df %>%
  col_vals_equal(vars(test_rise_pre), vars(test_rise_post), actions = warn_on_fail())

```

```{r validate = TRUE}

test_rise_naming_df %>%
  pointblank::test_col_vals_equal(vars(test_rise_pre), vars(test_rise_post))

```



## Calculating Composites

Calculating depressive symptoms using the Short Form Mood and Feelings Questionnaire (only measured pre-SSI). Scores range from 0 to 26, where 0 = not true, 1 = sometimes, 2 = true. Scores of 12 or higher suggest depression. Source: https://doi.org/10.1002/mpr.1610

```{r pulling mfq values}

## Pulling mfq variables

# vars_mfq <- data_rise_named %>%
#   select(contains("mfq")) %>%
#   head() %>%
#   print()

```

```{r mutating mfq values}

## Mutating character values to numeric across multiple mfq columns 

data_mfq_mutated <- data_rise_named %>%
  mutate(across(starts_with("mfq_") & -contains("tim"), 
                ~ case_when(
                    . == "Not True" ~ 0,
                    . == "Sometimes" ~ 1,
                    . == "True" ~ 2,
                    TRUE ~ NA_real_ # Handle other cases with NA
                )))

## checking mutation happened correctly

test_mfq_pre <- data_rise_named %>%
  group_by(mfq_1) %>%
  summarize(count = n()) %>% # counting responses pre-mutation
  arrange(desc(count)) # arranged in descending count order

test_mfq_pre

test_mfq_post <- data_mfq_mutated %>%
  mutate(across(starts_with("mfq_"), 
                ~ factor(., levels = unique(.)))) %>% # converting to factor class so we can count
  group_by(mfq_1) %>%
  summarize(count = n()) %>% # counting responses post-mutation
  arrange(desc(count)) # arranged in descending count order

test_mfq_post

identical(test_mfq_pre$count, test_mfq_post$count) # true if response counts match from pre to post mutation

```

```{r calculating mfq scores}

## Calculating composite mfq scores

data_mfq_scored <- data_mfq_mutated %>%
  mutate(mfq_total = rowSums(across(starts_with("mfq_") & -contains("tim"))))

## checking composite calculation was correct

test_mfq_calc <- data_mfq_scored %>%
  select(response_id, starts_with("mfq_") & -contains("tim")) %>%
  mutate(manual_mfq_total = mfq_1 + mfq_2 + mfq_3 + mfq_4 + mfq_5 +
                            mfq_6 + mfq_7 + mfq_8 + mfq_9 + mfq_10 +
                            mfq_11 + mfq_12 + mfq_13) # manually calculating mfq total

identical(test_mfq_calc$mfq_total, test_mfq_calc$manual_mfq_total) # true if mfq totals are identical across sum method

```

Calculating hopelessness using the 4-item Beck's Hopelessness Scale (measured pre and post SSI). Scores range from x to x, where 0 = not true, 1 = sometimes, 2 = true. Source: xxx

```{r pulling bhs values}

## Pulling mfq variables

# vars_bhs <- data_mfq_scored %>%
#   select(contains("bhs")) %>%
#   head() %>%
#   print()

```

